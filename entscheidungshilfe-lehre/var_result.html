<!DOCTYPE html>
<html lang="en">
<head>
  <title>Entscheidungshilfe</title>
  <meta charset="utf-8" />
  <meta http-equiv="content-language" content="de">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="../assets/css/eb.css" />
  <script src="../assets/js/jquery.min.js"></script>
  <script src="../assets/js/jquery.csv.js"></script>
</head>
<body class="is-preload resultBg" lang="de" onload="loadPage()">
    <div id="result" class="rCont notReady">
        <p>Ihr Ergebnis:</p>
        <div id="resOverview" class="block overview">
            <h3 id="scenarioTitle">Titel des Lehr-Lernszenarios</h3>
            <h4 id="scenarioSubtitle">mit asynchroner Teilnahme-Alternative</h4>
            <div class="blockContent">
                <p class="descText"></p>
                <img class="descImg" src="../images/pic05.jpg"/>
            </div>
            <div id="matchQuality" style="display:none; border-bottom: 0px" class="tip">
                <h5 onclick="showHideTip(this)">
                    <img src="../images/fwd3.svg" alt="">
                    <span>Wie geeignet ist dieses Lehrszenario für mich?</span>
                </h5>
                <div class="tipContent">
                    <div id="vorteile" style="display: none">
                        <p>Hier sind einige Gründe, warum dieses Szenario gut für Sie ist:</p>
                        <ul class="reasonList"></ul>
                    </div>
                    <div id="nachteile" style="display: none">
                        <p>Hier sind einige Aspekte des Szenarios, die vielleicht nicht direkt mit Ihren Erwartungen übereinstimmen:</p>
                        <ul class="reasonList"></ul>
                    </div>
                </div>

            </div>
        </div>
        <div id="resSync" class="block sync">
            <h4>Tipps für die synchrone Interaktion</h4>
            <div class="blockContent">
                <p class="descText"></p>
                <ul class="tCont"></ul>
            </div>
        </div>
        <div id="resAsync" class="block async">
            <h4>Tipps für die asynchrone Teilnahme</h4>
            <div class="blockContent">
                <p class="descText"></p>
                <ul class="tCont"></ul>
            </div>
        </div>
        <div id="resTechn" class="block techn">
            <h4>Medientechnische Voraussetzungen</h4>
            <div class="blockContent">
                <div class="descText">
                    <p>Eigenschaften:</p>
                    <ul id="propertyList" class="techList"></ul>
                    <p id="refToRaumkonzept">Raumskizzen, Signallaufpläne und Empfehlungen finden Sie im <b>Raumkonzept →</b></p>
                </div>
                <a id="linkRaumkonzept" href="" class="pdfLink">
                    <img src='../../images/entscheidungshilfe/raumkonzept_icon.png' alt="" />
                    <strong>Exemplarisches Raumkonzept (PDF)</strong>
                </a>
            </div>
        </div>
        <div id="resMore" class="block more">
            <h4>Weitere Ergebnissse</h4>
            <div class="blockContent">
                <p>Folgende Lehr-/Lernszenarien könnten auch für Sie passend sein:</p>
                <ul class="altCont"></ul>
            </div>
        </div>
    </div>
    <hr />
<script>


const urlParams = new URLSearchParams(window.location.search);
const shownScenario = urlParams.has('shownScenario') ? urlParams.get('shownScenario') : "se-rem-2-1-2"
const topTier = urlParams.has('topTier') ? JSON.parse(urlParams.get('topTier')) : ["se-rem-2-0-0","se-rem-2-3-0","se-hyb-2-0-0","se-hyb-2-3-0"]
const specialCases = urlParams.has('specialCases') ? urlParams.get('specialCases') : []
const providedAnswers = JSON.parse(sessionStorage.getItem("answers"))

const answers = providedAnswers? providedAnswers : {}
// {
//   "artLV": "SE",
//   "LZiP": "2",
//   "LZsy": "1",
//   "niePr": "nein",
//   "nieSync": "nein",
//   "regAbw": "abundzu",
//   "onlBereit": "geleg",
//   "limZPSt": "ja",
//   "onlZugang": "ja",
//   "IntAsync": "2",
//   "gaeste": "0",
//   "exkur": "nein",
//   "begrAnz": "nein",
//   "intKoll": "ja"
// }

function explainMatch(scenario, answers, rules){
    Object.entries(answers).forEach(function(item){
        let qCode = item[0]
        let aCode = item[1]
        let effectsForThisCombination = rule_data.filter((k)=>k.questionCode==qCode && k.answerCode==aCode)
        for (let effect of effectsForThisCombination){

            if (!isScenarioAffected(shownScenario, effect)){
                // only include effects that affect the displayed scenario!
                continue;
            }
            if (effect.scoreChange == "-100" || effect.scoreChange == "-"){
                // ignore effects that would have excluded this scenario and "noEffect"
                continue;
            } 
            if (effect.relevantVariable1 == "2" || effect.relevantVariable1 =="4"){
                // ignore effects that just define syncInt and asyncInt
                continue;
            }
            let sentence = document.createElement("li")
            let subsentence = effect.reasonSummary.replace("Szenario XYZ", "dieses Szenario")
            sentence.innerHTML = effect.answerSummary + " " + subsentence //+  " <b>(rule ID: " + effect.globalId + ")</b>"

            // if the effect is positive, add it to the first list (Vorteile)
            if (+effect.scoreChange > 0){
                document.querySelector("#vorteile .reasonList").append(sentence)
                document.querySelector("#matchQuality").style.display = "block"
                document.querySelector("#vorteile").style.display = "block"
            } else {
                // if the effect is negative, add it to the second list (Nachteile)
                document.querySelector("#nachteile .reasonList").append(sentence)
                document.querySelector("#matchQuality").style.display = "block"
                document.querySelector("#nachteile").style.display = "block"
            }            
        }
    })
    console.log("hallo")
}
// auxiliary functions for reading rules
function isScenarioInRange(scenarioCode, variable, range){
    // console.log(scenarioCode, variable, range)
    let scenarioVariable = scenarioCode.split("-")[variable]
    // turning the contents of the csv file into a list of strings
    let rangeList = $.csv.toArray(range).map(str => str.trim())
    return rangeList.includes(scenarioVariable)

}
function isScenarioAffected(scenarioCode, effect){
    // console.log(effect)
    let variable1 = effect.relevantVariable1, variable2 = effect.relevantVariable2
    let inRange1 = effect.includedRange1, inRange2 = effect.includedRange2
    let exRange1 = effect.excludedRange1, exRange2 = effect.excludedRange2
    // console.log(variable1, variable2, inRange1, inRange2, exRange1, exRange2)

    let match1 = variable1 == "-" ? true : isScenarioInRange(scenarioCode, variable1, inRange1)
    let match2 = variable1 != "-" && exRange1 == "-" ? false : !isScenarioInRange(scenarioCode, variable1, exRange1)
    let match3 = variable2 == "-" ? true : isScenarioInRange(scenarioCode, variable2, inRange2)
    let match4 = variable2 != "-" && exRange2 == "-" ? false : !isScenarioInRange(scenarioCode, variable2, exRange2)

    // console.log(match1, match2, match3, match4)
    return (match1 || match2) && (match3 || match4)

}



// var shownScenario = 'se-rem-2-1-1'

var all_tips, all_texts, tip_matching, rule_data

function loadPage(){
    const rCont = document.getElementById("result")
    rCont.classList.add("notReady")
    $.getJSON("data.json", function(json){
    all_scenarios = json['scenarios']
    $.get( "texts_tips_matrix.csv", function(CSVdata) {
        let csvData = $.csv.toObjects(CSVdata, {separator:';'});
        all_texts = {}
        tip_matching = {}
        csvData.forEach(function(dict){
            let key = dict["wert"]
            delete dict["wert"]
            all_texts[key] = Object.fromEntries(Object.entries(dict).filter(([k,v])=>k.includes("text")))
            all_texts[key]["name"] = dict["name"]
            tip_matching[key] = Object.fromEntries(Object.entries(dict).filter(([k,v])=>k.includes("tips")))
        })
        $.get("tips_source.json", function(json){
            all_tips = json["tips"]
            setTimeout(function(){
                showResult(shownScenario, specialCases, topTier)
                createAriaLabels()
            }, 500)
        })
        
    });
    $.get("regeln_formulierungen.csv", function(CSVdata){
        rule_data =  $.csv.toObjects(CSVdata, {separator:';'});
        // explainMatch(shownScenario, answers, rule_data)  
    })
})
}

var fullTipList

function showResult(scenario='de-default-0-0-0', specialCases=[], topTier=[]){
    // gathering texts
    
    let scenarioValue = scenario.split("-")[0] + "-" + scenario.split("-")[1]
    let syncIntValue = "syncInt-" + scenario.split("-")[2]
    let asyncTNValue = "asyncTN-" + scenario.split("-")[3]
    let asyncIntValue = "asyncInt-" + scenario.split("-")[4]

    let scenarioTitle = all_texts[scenarioValue]['name']

    let theseTexts = {}
    let l = ['overview', "overviewAsyncTN", 'technik', syncIntValue, asyncTNValue, asyncIntValue]
    l.forEach(function(s){
        let val = all_texts[scenarioValue]["text_" + s]
        if (val != '-'){
            theseTexts[s + 'Text'] = val
        } else {
            theseTexts[s + 'Text'] = all_texts['de-default']["text_" + s]
        }
    })
    let overviewText = theseTexts['overviewText']
    let overviewAsyncTNText = theseTexts['overviewAsyncTNText']
    let technPoints = theseTexts['technikText']
    let syncIntText =  theseTexts[syncIntValue + "Text"]
    let asyncTNText =  theseTexts[asyncTNValue + "Text"]
    let asyncIntText =  theseTexts[asyncIntValue + "Text"]
    let asyncText = asyncTNText + " " + asyncIntText

    // gathering tips
    // synchronous
    let syncTips = []
    let tipsGeneral = tip_matching[scenarioValue]["tips_general"]
    let tipsSyncInt = tip_matching[scenarioValue]["tips_" + syncIntValue]
    let tipsAsyncTN = tip_matching[scenarioValue]["tips_" + asyncTNValue]
    let tipsAsyncInt = tip_matching[scenarioValue]["tips_" + asyncIntValue]

    
    let fullTipListAsString = tipsGeneral + ", " + tipsSyncInt + ", " + tipsAsyncTN + ", " + tipsAsyncInt
    fullTipList = fullTipListAsString.split(", ").filter((k)=>k != "-")

    let fullTechnList = technPoints.split(', ')
    console.log(fullTechnList)

    let syncTipList = fullTipList.filter((tipCode)=>all_tips[tipCode]["type"] == "synchron")
    let asyncTipList = fullTipList.filter((tipCode)=>all_tips[tipCode]["type"] == "asynchron")


    // building document
    // Title and Overview
    document.querySelector("#scenarioTitle").innerHTML = scenarioTitle
    if (asyncTNValue == "asyncTN-3"){
        document.querySelector("#scenarioSubtitle").style.display="block"
        overviewText = overviewText + '<br><br>' + overviewAsyncTNText
    }
    document.querySelector("#resOverview > .blockContent > .descText").innerHTML = overviewText
    document.querySelector("#resOverview > .blockContent > .descImg").setAttribute("src", "../images/entscheidungshilfe/sampleResult.png")
    document.querySelector("#resOverview > .blockContent > .descImg").setAttribute("alt", "Studenten und Studentinnen in einem Raum.")

    // Sync block
    document.querySelector("#resSync > .blockContent > .descText").innerHTML = syncIntText
    let syncTipsCont = document.querySelector("#resSync > .blockContent > .tCont")
    syncTipList.forEach(function(tipCode){
        addTip(tipCode, syncTipsCont)
    })

    // Async block
    document.querySelector("#resAsync > .blockContent > .descText").innerHTML = asyncText
    let asyncTips = document.querySelector("#resAsync > .blockContent > .tCont")
    asyncTipList.forEach(function(tipCode){
        if (tipCode != scenario){
            addTip(tipCode, asyncTips)
        }

    })

    // Medientechnik block
    fullTechnList.forEach(function(s){
        let li = document.createElement('li')
        console.log(s)
        li.innerHTML = s
        document.querySelector("#propertyList").appendChild(li)
        if (s == 'COMINGSOON'){
            document.querySelector(".techn .descText").innerHTML = '<p>Die Medientechnischen Voraussetzungen für dieses Szenario sind noch nicht veröffentlicht.</p>'
        } else if (s == 'digital'){
            document.querySelector(".techn .descText").innerHTML = '<p>Dieses Lehrszenario findet in rein-digitalem Format statt.</p>'
            document.querySelector("#linkRaumkonzept").style.display='none'
        }
    }

    )

    // Alternative Results block
    let altResults = document.querySelector("#resMore > .blockContent > .altCont")
    topTier.forEach(function(resCode){
        if (resCode != scenario){
            addAltResult(resCode, altResults)
        }
        
    })
    
    document.getElementById("result").classList.remove("notReady")
}

// creating HTML elements
function addTip(tipCode, container){
        let tipli = document.createElement("li"); container.append(tipli)
                tipli.classList.add("tip")
                let tipHeader = document.createElement("h5"); tipli.append(tipHeader)
                tipHeader.innerHTML = "<img src='../images/fwd3.svg' alt=''/><span>" + all_tips[tipCode]["title"] + "</span>"
                let tipContent = document.createElement("p"); tipli.append(tipContent)
                tipContent.classList.add("tipContent")
                tipContent.innerHTML = all_tips[tipCode]["content"]
                
                tipHeader.setAttribute("onclick", "showHideTip(this)")
    }

    function showHideTip(th){
        let a = th.parentElement
        if (a.classList.contains("open")){
            a.classList.remove("open")
        } else {
            a.classList.add("open")
        }

    }

    function addAltResult(resCode, container){
        let li = document.createElement("li"); container.append(li)
        li.classList.add("altScenario")
        let a = document.createElement("a"); li.append(a)
        a.setAttribute("href", "var_result.html?shownScenario=" + resCode + "&topTier=" + JSON.stringify(topTier))
        let resValue = resCode.split('-')[0] + '-' + resCode.split('-')[1]
        let resAsyncTN = resCode.split('-')[3]
        let extraStatement = resAsyncTN == '3'? ' (mit asynchroner Teilnahme-Alternative)' : ''
        a.innerHTML = all_texts[resValue]["name"] + extraStatement
        // a.setAttribute("onclick", "showResult('" + resCode + "', special_cases = [], topTier=topResults)")
    }

    function createAriaLabels(){
        for (var a of document.querySelectorAll('a')){
            if (!a['aria-label']){
                if (a['title']){
                    a.setAttribute('aria-label', a['title'])
                } else if (a.innerHTML != ''){
                    a.setAttribute('aria-label', a.innerHTML)
                } else {
                    console.log(a, "no content found")
                }
            }
        }
        
    }
</script>
</body>
</html>