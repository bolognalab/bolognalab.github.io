<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Entscheidungshilfe</title>
  <meta charset="utf-8" />
  <meta http-equiv="content-language" content="de">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <noscript><link rel="stylesheet" href="../assets/css/noscript.css" /></noscript>
  <link rel="stylesheet" href="../assets/css/eb.css" />
<script src="../assets/js/jquery.min.js"></script>
</head>
<body class="is-preload" lang="de">
<h2>Fragereihe-Ansicht - Entscheidungshilfe Online und Hybride Lehre</h2>
<div style="display: table; width: 100%">
    <div id="questions" class="qCont"></div>
    <div id="scenarios" class="sCont"></div>
</div>
<script>
    const qCont = document.getElementById("questions")
    const sCont = document.getElementById("scenarios")
    var all_data, questionInfo, all_scenarios
    
    var nextQuestionIdx = 0

    var scenarios = {}
    var colorMapping = {
        "-100": "#C00000",
        "-2": "#f77e59",
        "-1": "#ffa185",
        "0": "#FFEB84",
        "1": "#D4DE89",
        "2": "#A9D08E",
        "FUNC": "#FFFFAA"
    }
//  'artLV',
    var questionOrder = [ 
        'artLV', 
        'modulCombo',
        'LZiP',
        'LZsy', 
        'niePr',
        'nieSync',
        // 'wohnLP',
        'regAbw',
        "onlBereit", 
        "limZPSt",
        "onlZugang",
        "IntAsync",
        'gaeste', 
        'gaesteMittel',
        "exkur",
        "exkurMittel",
        'begrAnz',
        "intKoll"
    ]
    var answers = {}
    var activeScenarios = {}
    var deltas = {} // stores previous scores
    var recent = []

    $.getJSON("data.json", function(json){
        all_data = json
        questionInfo = json['questions']
        all_scenarios = json['scenarios']
        Object.entries(all_scenarios).forEach((s)=>{activeScenarios[s[0]] = 0})
        displayQuestion(questionOrder[nextQuestionIdx])
        // listActiveScenarios(activeScenarios)
        // makeTable(questionInfo, shownScenarios)
    })
    
    function displayQuestion(qKey){
        let q = questionInfo[qKey]
        let qText = q.text

        let qDiv = document.createElement("div"); qCont.append(qDiv)
        qDiv.setAttribute("id", "DIV_" + qKey)
        let qP = document.createElement("p"); qDiv.append(qP)
        qP.setAttribute("id", "Q_" + qKey)
        qP.innerHTML = qText

        Object.entries(q.antworten).forEach((a)=>{
            let aKey = a[0]
            let aText = a[1].text
            let aEffects = a[1].effects
            let aConditionalEffects= a[1].conditionalEffects

            let aDiv = document.createElement("div"); qDiv.append(aDiv)
            let aRadio = document.createElement("input")
            aRadio.setAttribute("type", "radio")
            aRadio.setAttribute("name", "Q_" + qKey)
            aRadio.setAttribute("id", "Q_" + qKey + "_A_" + aKey)
            aRadio.setAttribute("value", aKey)
            aRadio.addEventListener("click", function(){
                console.log(this.parentElement.parentElement)
                let nButton = this.parentElement.parentElement.getElementsByClassName("nextButton")[0]
                console.log(nButton)
                nButton.disabled = false
                console.log(nButton)
                selectAnswer(qKey, aKey)

            })
            let aLabel = document.createElement("label")
            aLabel.setAttribute("for", "Q_" + qKey + "_A_" + aKey)
            aLabel.innerHTML = aText

            aDiv.append(aRadio, aLabel)
            if (aKey == "PR" | aKey =="SO"){
                aDiv.style.display = "none"
            }            

        })

        let pButton = document.createElement("button"); qDiv.append(pButton)
        pButton.classList.add("prevButton")
        pButton.innerHTML = "Vorherige Frage"
        pButton.addEventListener("click", function(){
            undoAnswer()
        })
        pButton.disabled = true

        let nButton = document.createElement("button"); qDiv.append(nButton)
        nButton.classList.add("nextButton")
        nButton.innerHTML = "NÃ¤chste Frage"
        nButton.addEventListener("click", function(){
            submitAnswer(qKey, answers[qKey])
            nButton.remove()
            pButton.remove()
        })
        nButton.disabled = true
        


        nextQuestionIdx += 1
    }
    function selectAnswer(qKey, aKey){
        answers[qKey] = aKey
    }
    function submitAnswer(qKey, aKey){
        let allRadios = document.getElementById("DIV_" + qKey).querySelectorAll("input")
        recent = []
        for (let radio of allRadios){
            if (radio.id == "Q_" + qKey + "_A_" + aKey){
                radio.classList.add("selected")   
            }
            radio.setAttribute("disabled", true)
        }

        let effects = questionInfo[qKey]["antworten"][aKey]["effects"]
        let conditionalEffects = questionInfo[qKey]["antworten"][aKey]["conditionalEffects"]

        Object.entries(effects).forEach((entry)=>{
            // if (entry[1]== -100){
                
            //     delete activeScenarios[entry[0]]
            // } else if (Object.keys(activeScenarios).includes(entry[0]) && entry[1] != "FUNC"){
            //     let scoreVal = +(activeScenarios[entry[0]])
            //     newScoreVal = scoreVal + entry[1]
            //     activeScenarios[entry[0]] = newScoreVal
            //     recent.push(entry[0])
            // }
            if (Object.keys(activeScenarios).includes(entry[0]) && entry[1] != "FUNC"){
                let scoreVal = +(activeScenarios[entry[0]])
                newScoreVal = scoreVal + entry[1]
                activeScenarios[entry[0]] = newScoreVal
                recent.push(entry[0])
            }
        })

        Object.entries(conditionalEffects).forEach((entry)=>{
            let sKey = entry[0]
            let sEffects = entry[1]
            console.log(sKey)
            Object.entries(sEffects).forEach((sEntry)=>{
                let conditions = sEntry[0]
                let score = sEntry[1]
                // console.log(conditions, score)
                // separate conditions if more than one
                let met = andCheck(conditions)
                if (met){
                    let scoreVal = +(activeScenarios[entry[0]])
                    newScoreVal = scoreVal + score
                    activeScenarios[entry[0]] = newScoreVal
                    recent.push(sKey)
                }
            })
            
        })

        setTimeout(()=>{
            listActiveScenarios(activeScenarios)
        }, 100)

        if (nextQuestionIdx < questionOrder.length){
            let nextQuestion = questionOrder[nextQuestionIdx]
            let includeNextQuestion = includeCheck(nextQuestion)
            if (includeNextQuestion==true){
                displayQuestion(nextQuestion)
            } else {
                if (nextQuestionIdx + 1 < questionOrder.length){
                    nextQuestionIdx +=1
                    displayQuestion(questionOrder[nextQuestionIdx])
                }
            }
            
        }
    }
    
    function includeCheck(qKey){
        // checks if a question should be displayed
        // assumes that questions have been ordered correctly, otherwise results may be unexpected
        let condition = questionInfo[qKey]["condition"]
        if (condition == true){
            return true
        } else {
            return andCheck(condition)
        }
        
    }

    function andCheck(conditions){
        // checks if all conditions qKey=aKey are simultaneously true
        let i = 0
        while (i < 10){
            [qKey, aKey] = conditions.split("+")[i].split("=")
            if (qKey.includes("!")){
                // check if it's a NOT test
                qKeyR = qKey.split("!")[0]
                if (answers[qKeyR] == aKey | !answers[qKeyR]){
                    return false
                } else {
                    i += 1
                }
            } else {
                if (answers[qKey] != aKey){
                return false
                } else {
                    i += 1
                }
            }

            if (i >= conditions.split("+").length){
                return true
            }
        }
        conditions.split("+").forEach((condition, i)=>{
            [qKey, aKey] = condition.split("=")
            console.log(condition, qKey, aKey)
            if (answers[qKey] != aKey){
                if (i <4){
                    realConditions[i] = false
                } else {
                    console.log("only up to 4 simultaneous conditions supported; the rest are ignored")
                }
            }
        })
        
    }

    function listActiveScenarios(sObju, sorted=false){
        sObj = Object.entries(sObju).sort(([,a],[,b]) => b-a).reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
        sCont.innerHTML = ""
        Object.entries(sObj).forEach((entry)=>{
            sKey = entry[0]
            sVal = entry[1]
            let tr = document.createElement("tr")
            let name = document.createElement("th")
            let score = document.createElement("td")
            name.innerHTML = sKey 
            score.innerHTML = sVal
            score.setAttribute("id", "SCORE_" + sKey)
            score.classList.add("score")
            tr.append(name, score)
            if (recent.includes(sKey)){
                tr.classList.add("recent")
            }
            sCont.append(tr)
        })
        console.log(Object.keys(sObj).length)

        for (let score of document.querySelectorAll(".score")){
            let value = +(score.innerHTML)
            if (value > 0){
                score.style.color = "#0e7700"
            } else if (value <0){
                score.style.color = "#d93300"
            } else {
                score.style.color = "#585858"
            }
        }
    }

    function updateScore(code, answers){
        Object.entries(answers).forEach(function(entry){
            qKey = entry[0]
            aKey = entry[1]
            let effects = questionInfo[qKey]["antworten"][aKey]["effects"]
            let conditionalEffects = questionInfo[qKey]["antworten"][aKey]["conditionalEffects"]

            Object.entries(effects).forEach((entry)=>{
                // TODO: Continue here
                if (Object.keys(activeScenarios).includes(entry[0]) && entry[1] != "FUNC"){
                    let scoreVal = +(activeScenarios[entry[0]])
                    newScoreVal = scoreVal + entry[1]
                    activeScenarios[entry[0]] = newScoreVal
                    recent.push(entry[0])
                }
            })

            Object.entries(conditionalEffects).forEach((entry)=>{
                let sKey = entry[0]
                let sEffects = entry[1]
                console.log(sKey)
                Object.entries(sEffects).forEach((sEntry)=>{
                    let conditions = sEntry[0]
                    let score = sEntry[1]
                    // console.log(conditions, score)
                    // separate conditions if more than one
                    let met = andCheck(conditions)
                    if (met){
                        let scoreVal = +(activeScenarios[entry[0]])
                        newScoreVal = scoreVal + score
                        activeScenarios[entry[0]] = newScoreVal
                        recent.push(sKey)
                    }
                })
                
            })
        })
    }

        
</script>
</body>
</html>