<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Entscheidungshilfe: FLOW</title>
    <meta charset="utf-8" />
    <meta http-equiv="content-language" content="de">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
    <link rel="stylesheet" href="assets/css/eb.css" />
    <link rel="stylesheet" href="assets/css/eb_app.css" />
    <script src="assets/js/jquery.min.js"></script>
</head>
<style>
body {
    background: white;
    }
.qCont {
    background: var(--backgroundLightBlue);
            background: linear-gradient(90deg, rgba(18, 161, 154, 0.5) 0%, rgba(15, 113, 184, 0.5) 100%)
}
#selectAtLeastOne {
    background: rgba(18, 161, 154, 0);
    transition: all 2s ease;
    border-radius: 0.5em;
    padding: 0.2em;
}
</style>
<body class="is-preload" lang="de">
<div style="width: 100%; height: 50em; overflow:scroll">
    <h3>Entscheidungshilfe Lehre: Testversion mit Score-Anzeige</h3>
    <div id="qWrapper">
        <script>
            $("#qWrapper").load("app.html #questions", ()=>{
                document.querySelector("#credits").style.display="none"
                loadQuestions()
            })
        </script>
    </div>  
</div>
<h3>Szenarien und Scores</h3>
    <p>Filter: <input id="queryField" type="text"></input><button onclick="updateQuery()">Anwenden</button></p>
    <div id="scenarios" class="sCont"></div>
<script src="assets/js/jquery.csv.js"></script>
<script src="assets/js/questionFlow.js"></script>
<script>
    var qCont, sCont
    const maxShownAnswers = 4

    var all_data, questionInfo, all_scenarios, all_special_cases, topResults
    var testing = true
    var activeQ, activeA
    var nextQuestionIdx = 1
    var scenarios = {}
    var answers = {}
    var activeScenarios = {}
    var recent = [] 

    const questionOrder = [ 
        "TEXT_welcome",
        // 'TEXT_intro',
        'TEXT_group1',
        'artLV', 
        'TEXT_labore',
        // 'anzahlVL', 
        // 'anzahlSE',
        'interactions',
        'leistungen',
        'TEXT_group2',
        "niveauSt",
        "limZPSt",
        'nieSync',
        'niePr',
        "TEXT_group3",
        'regAbw',
        "onlBereit", 
        "TEXT_group4",
        "situations",
        'gaeste', 
    ]   
    var leistungenQuestion, situationsQuestion, interactionsQuestion

       
    // functions and variables unique to the testing file
    var all_texts
    var query = ""
    function updateQuery(){
        query = document.querySelector("#queryField").value
        listActiveScenarios(activeScenarios)
    }
    // shows live-scores below tool for testing purposes
    function listActiveScenarios(sObju){
        sObj = Object.entries(sObju).sort(([,a],[,b]) => b-a).reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
        sCont.innerHTML = ""
        Object.entries(sObj).forEach((entry)=>{
            sKey = entry[0]
            sVal = entry[1]
            if (query == "" || sKey.includes(query)){
                let tr = document.createElement("p")
                let name = document.createElement("span")
                name.classList.add("sName")
                let score = document.createElement("span")
                name.innerHTML = sKey
                let scenarioTitle = all_texts[sKey.slice(0,-6)].name
                name.setAttribute("title", scenarioTitle)
                score.innerHTML = sVal
                score.setAttribute("id", "SCORE_" + sKey)
                score.classList.add("score")
                tr.append(name, score)
                if (recent.includes(sKey)){
                    tr.classList.add("recent")
                }
                sCont.append(tr)
            }

        })

        for (let score of document.querySelectorAll(".score")){
            let value = +(score.innerHTML)
            if (value > 0){
                score.style.color = "#0e7700"
            } else if (value <0){
                score.style.color = "#d93300"
            } else {
                score.style.color = "#585858"
            }
        }
    }
    //sorts identical scenarios according to asynhronous interaction level
    function sortByAsyncInt(arr){
        // Step 1: Group by prefix
        const grouped = {};

        arr.forEach(item => {
        const match = item.match(/^(.*?)-(\d+-\d+-\d+)$/);
        if (!match) return;

        const prefix = match[1];
        const digits = match[2];

        if (!grouped[prefix]) grouped[prefix] = [];
        grouped[prefix].push(digits);
        });

        // Step 2: Sort each group of digits
        Object.keys(grouped).forEach(prefix => {
        grouped[prefix].sort((b, a) => {
            const [a1, a2, a3] = a.split("-").map(Number);
            const [b1, b2, b3] = b.split("-").map(Number);

            if (a1 !== b1) return a1 - b1;
            if (a2 !== b2) return a2 - b2;
            return a3 - b3;
        });
        });

        // Step 3: Recombine into final array, keeping prefix order
        const final = [];
        Object.keys(grouped).forEach(prefix => {
        grouped[prefix].forEach(digits => {
            final.push(`${prefix}-${digits}`);
        });
        });
        return final
    }

    var progressBar, whichPart, pButton, nButton, sButton

    function loadQuestions(){ 
        qCont = document.getElementById("questions")
        sCont = document.getElementById("scenarios")
        
        // make progress bar
        progressBar = document.getElementById("progressBar")
        for (i=0; i<questionOrder.length+1; i++){
            let bit = document.createElement("div"); progressBar.append(bit)
            bit.classList.add("bit")
            bit.setAttribute("id", "prog_"+ i)
        }
        whichPart = document.querySelector("#whichPart")

        // Previous Question, Next Question, Submit buttons (will be moved around)
        pButton = document.createElement("button"); document.body.append(pButton)
        pButton.classList.add("prevButton", "asIcon")
        pButton.setAttribute("id", "prevButton")
        // pButton.innerHTML = "Vorherige Frage"
        pButton.addEventListener("click", function(){
            undoAnswer(verbose=true)
        })
        pButton.style.display = "none"

        nButton = document.createElement("button"); document.body.append(nButton)
        nButton.classList.add("nextButton", "asIcon")
        nButton.setAttribute("id", "nextButton")
        // nButton.innerHTML = "NÃ¤chste Frage"
        nButton.addEventListener("click", function(){
            if (activeQ.includes("TEXT_")){
                proceedFromQuestion()
            } else {
                if (activeQ != "situations" && activeQ != "leistungen"){
                    if (activeQ == "interactions"){
                        submitSingleAnswer(qq="intSync", aa=answers["intSync"], proceed=false, verbose=testing)
                        // this doesn't do anything but proceed
                        submitSingleAnswer(qq = "interactions", aa="inputs", proceed=true, resetRecent=false, verbose=testing)
                    } else {
                        submitSingleAnswer(qq=activeQ, aa=activeA, proceed=true, resetRecent=true, verbose=testing)
                    }
                } else {
                    answersToSubmit = {}
                    Object.keys(questionInfo[activeQ]["antworten"]).forEach((a, idx, array)=>{
                        answersToSubmit[a] = answers[a]
                        if (idx === array.length -1 ){
                            if (activeQ == "leistungen"){
                                // special case: if none of the tasks are selected, set keineLeistungen=ja in order to apply some effects
                                answersToSubmit["keineLeistungen"] = answers["keineLeistungen"]
                            }
                            console.log(answersToSubmit)
                            submitMultipleAnswers(answersToSubmit, activeQ, verbose=testing)
                        }
                    })
                }
            }


        })
        nButton.style.display = "none"

        sButton = document.createElement("button"); document.body.append(sButton)
        sButton.classList.add("submitButton")
        sButton.setAttribute("id", "submitButton")
        sButton.innerHTML = "Absenden"
        sButton.addEventListener("click", function(){
            submitSingleAnswer(qq=activeQ, aa=activeA, verbose=testing)
            sessionStorage.setItem("answers", JSON.stringify(answers))
            if (testing){
                if (confirm("Zum Ergebnis?") == true){
                    getResult(activeScenarios)
                }
            } else {
                getResult(activeScenarios)
            }
        })
        sButton.style.display = "none"

        $.getJSON("data.json", function(json){
            all_data = json
            questionInfo = json['questions']
            all_special_cases = json['special']
            situationsQuestion = questionInfo["situations"]
            leistungenQuestion = questionInfo["leistungen"]
            interactionsQuestion = questionInfo["interactions"]
            all_scenarios = json['scenarios']
            Object.entries(all_scenarios).forEach((s)=>{
                activeScenarios[s[0]] = 0
            })
            document.querySelector("#start").style.display = "block"
            
            // read texts_tips_matrix to get scenario titles
            $.get( "texts_tips_matrix.csv", function(CSVdata) {
            let csvData = $.csv.toObjects(CSVdata, {separator:';'});
            all_texts = {}
            csvData.forEach(function(dict){
                let key = dict["wert"]
                delete dict["wert"]
                all_texts[key] = Object.fromEntries(Object.entries(dict).filter(([k,v])=>!k.includes("text")))
                all_texts[key]["name"] = dict["name"]
            })        
            });
            setTimeout(()=>{
                listActiveScenarios(activeScenarios)
            }, 100)
            // start()
        })
    }
</script>
</body>
</html>
